# Ruby5 555

[Episode 555](https://ruby5.codeschool.com/episodes/597-episode-555-june-2nd-2015/stories/4726-make-your-own-rack-server)

## Make Your Own Rack Server

Rackサーバを自分で書いてSinatraアプリを動かす

[Make Your Own Rack Server](http://www.blrice.net/blog/2015/05/31/make-your-own-rack-server/)

### Rackアプリとは

railsやsinatraなどのRubyでWebアプリを作る場合のインターフェース.
ステータス,ヘッダ,ボディの配列を返すcallメソッドを用意する.

````ruby:config.ru

class Foo
  def call(env)
    [200, {'Content-Type' => 'text/plain'}, ['Hello']]
  end
end

run Foo.new
````

[参考: Rack解説](http://qiita.com/higuma/items/838f4f58bc4a0645950a)

Rackハンドラでrackサーバの違いを吸収する

### サーバサイド

Rack::Handerの仕組みによってRackアプリケーションからサーバを指定できるようになる.

````ruby
Rack::Hander.register 'server name', 'Rack::Handler::MyServer'
````

Rack::HandlerのクラスはRackアプリケーションを受け取るクラスメソッド`run`を実装し`run`の中でリクエストを受け付ける無限ループを実行する.

````ruby
module Rack
  module Handler
    class MyServer
      self.run(app, opts)
        loop do
          ...
        end
      end
    end
  end
end
````

リクエストの受付は`TCPServer#accept`で受け取りRackアプリに渡す環境変数Hashを作成する.Rackアプリの環境変数Hashの仕様は[ここ](http://www.rubydoc.info/github/rack/rack/master/file/SPEC)で定義されている.

````
socket = TCPServer.new host, port

loop do
  socket.accept
  request = socket.gets
  env = new_env *request.split
  status, headers, body = app.call env

  socket.print <<-HTML
HTTP/1.1 200 OK
Content-Type: text/html
Server: MyServer
Connection: close

<html><body>

...

</body></html>
  HTML

  socket.close
end

````

### 思うところ

Rackアプリを作ることはあってもサーバを作ることはないので実際にcallメソッドを呼び出している部分を見ると感動する.
`thin`とか`puma`とかもう怖くない？
RackHandlerのおかげで気軽にサーバを設定できるようになっている.

##
